name: Build agents

on:
  schedule:
    - cron:  '44 21 */2 * *'

  workflow_dispatch:

jobs:
  check:
    name: check for new release
    runs-on: ubuntu-latest
    outputs:
      last-release-name: ${{ steps.release.outputs.last-release-name }}
      last-release-date: ${{ steps.release.outputs.last-release-date }}
      previous-release-date: ${{ steps.previous.outputs.previous-release-date }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: When was the last release?
        id: release
        run: |
            REPO=amidaware/rmmagent
            LAST_RELEASE=$(curl -s https://api.github.com/repos/$REPO/releases | jq -r '.[0]')
            LAST_RELEASE_NAME=$(echo $LAST_RELEASE | jq -r '.name')
            LAST_RELEASE_DATE=$(echo $LAST_RELEASE | jq -r '.published_at')
            
            echo "last-release-name=$LAST_RELEASE_NAME" >> $GITHUB_OUTPUT
            echo "last-release-date=$LAST_RELEASE_DATE" >> $GITHUB_OUTPUT
            
      - name: make previous last-release-date available
        id: previous
        env:
          PREV: ${{ secrets.TRMM_AGENT_LAST_RELEASE_DATE }}
        run: |            
            echo "previous-release-date=$PREV" >> $GITHUB_OUTPUT

  build:
    needs: check
    #if: needs.check.outputs.last-release-date != needs.check.outputs.previous-release-date
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64, arm]
        os: [linux, windows, freebsd, android, openbsd, darwin, ios]
        exclude:
          - arch: arm
            os: darwin
          - arch: arm
            os: ios
          - arch: arm
            os: windows
          - arch: arm64
            os: windows
    steps:
  
    # use secrets of this repo for persistant storage between worklows
      - name: Set new last release date as secret
        uses: hmanzur/actions-set-secret@master
        with:
         name: 'TRMM_AGENT_LAST_RELEASE_DATE'
         value: ${{ needs.check.outputs.last-release-date }}
         token: ${{ secrets.REPO_ACCESS_TOKEN }}
    
    
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '>=1.18.0'

      - name: Clone RMM Agent Repository
        uses: actions/checkout@v3
        with:
          repository: amidaware/rmmagent

      - name: build Binaries
        run: go build -o release/rmmAgent_${{ matrix.os }}_${{ matrix.arch }} -ldflags "-s -w"
        env:
          CGO_ENABLED: "0"
          GOARCH: ${{ matrix.arch }}
          GOOS: ${{ matrix.os }}
          
      - name: release Agent builds
        uses: ncipollo/release-action@master
        with:
          allowUpdates: true
          replacesArtifacts: true
          removeArtifacts: true
          name: "Linux Agents"
          commit: main
          tag: latest
          artifacts: "release/*.go"
          body: | 
            ${{ needs.check.outputs.last-release-name }}
            released on: ${{ needs.check.outputs.last-release-date }}
          token: ${{ secrets.GITHUB_TOKEN }}
